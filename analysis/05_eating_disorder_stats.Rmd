---
title: "03_eating_disorder_stats"
author: "SP"
date: "`r Sys.Date()`"
output: 
  workflowr::wflow_html: 
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    number_sections: true
    df_print: paged
    fig_width: 11
    fig_height: 8
    fig_caption: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, echo = FALSE)
# knitr::opts_knit$set(root.dir = dirname(getwd()))
```

```{r libs, include=FALSE}
do_source_data_creation <- FALSE
source("code/eating_disorder_data_proc.R")
load_inst_pkgs("tidyverse", "psych", "DescTools", "janitor", "knitr")
```

# Modelling
```{r echo=TRUE}
n_tests <- 39
```

## Essstörungen während Pandemie {.tabset .tabset-pills}
### Fälle mit ED-Diagnose
```{r echo=TRUE}
mod_ed_pan <- kruskal.test(icd_f50 ~ covid_pan, df_ed)
# mod_ed_pan <- tabyl(df_ed, icd_f50, covid_pan) %>% chisq.test()
mod_ed_pan
```
Corrected p-value for multiple testing is: `r format(mod_ed_pan[["p.value"]]*n_tests, scientific = FALSE)`

### ED-Subgruppe Anorexie
```{r echo=TRUE}
mod_an_pan <- kruskal.test(f50_type == "Anorexie" ~ covid_pan, df_ed)
mod_an_pan
```
Corrected p-value for multiple testing is: `r format(mod_an_pan[["p.value"]]*n_tests, scientific = FALSE)`

### ED-Subgruppe Bulimie
```{r echo=TRUE}
mod_bu_pan <- kruskal.test(f50_type == "Bulimie" ~ covid_pan, df_ed)
mod_bu_pan
```
Corrected p-value for multiple testing is: `r format(mod_bu_pan[["p.value"]]*n_tests, scientific = FALSE)`

### ED-Subgruppe sonstige Esstörungen
```{r echo=TRUE}
mod_edsonst_pan <- kruskal.test(f50_type == "Essstörung Sonst." ~ covid_pan, df_ed)
mod_edsonst_pan
```
Corrected p-value for multiple testing is: `r format(mod_edsonst_pan[["p.value"]]*n_tests, scientific = FALSE)`


## klinische Präsentation während Pandemie {.tabset .tabset-pills}
### jüngeres Alter
```{r echo=TRUE}
# kruskal.test(age_adm ~ covid_pan, df_ed)
mod_age_pan <- oneway.test(age_adm ~ covid_pan, df_ed)
mod_age_pan
```
Corrected p-value for multiple testing is: `r format(mod_age_pan[["p.value"]]*n_tests, scientific = FALSE)`

### Geschlecht
```{r echo=TRUE}
# kruskal.test(age_adm ~ covid_pan, df_ed)
mod_sex_pan <- kruskal.test(sex ~ covid_pan, df_ed)
mod_sex_pan
```
Corrected p-value for multiple testing is: `r format(mod_sex_pan[["p.value"]]*n_tests, scientific = FALSE)`

### Zunahme Komorbiditäten - F
```{r echo=TRUE}
mod_como_f_pan <- oneway.test(n_icd_f ~ covid_pan, df_ed)
mod_como_f_pan
```
Corrected p-value for multiple testing is: `r format(mod_como_f_pan[["p.value"]]*n_tests, scientific = FALSE)`

### Zunahme Komorbiditäten - !F
```{r echo=TRUE}
mod_como_other_pan <- oneway.test(n_icd_other ~ covid_pan, df_ed)
mod_como_other_pan
```
Corrected p-value for multiple testing is: `r format(mod_como_other_pan[["p.value"]]*n_tests, scientific = FALSE)`

### Abnahme (!) Behandlungsdauer
```{r echo=TRUE}
mod_los_pan <- oneway.test(length_stay_brutto ~ covid_pan, df_ed)
mod_los_pan
```
Corrected p-value for multiple testing is: `r format(mod_los_pan[["p.value"]]*n_tests, scientific = FALSE)`

### re-admissions (v1)
```{r}
# non-ED
chisq.test(matrix(c(226, 225, 575, 576), nrow = 2))
# ED
chisq.test(matrix(c(39, 63, 54, 98), nrow = 2))
# combined
chisq.test(matrix(c(226+39, 225+63, 575+54, 576+98), nrow = 2))
```

### re-adm 6 months
```{r}
kruskal.test(re_adm_soon_nona ~ covid_pan, df_ed)
kruskal.test(re_adm_soon_nona ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
kruskal.test(re_adm_soon_nona ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
```

### age
```{r}
oneway.test(age_adm ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
oneway.test(age_adm ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
```

### sex
```{r}
kruskal.test(sex ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
kruskal.test(sex ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
```

### n diagnoses
```{r}
oneway.test(n_icd_code ~ covid_pan, df_ed)
oneway.test(n_icd_code ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
oneway.test(n_icd_code ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
```

### somatic comorbidities
```{r}
oneway.test(n_icd_other ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
oneway.test(n_icd_other ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
```

### psychiatric comorbidities
```{r}
oneway.test(n_icd_f ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
oneway.test(n_icd_f ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
```

### LOS
```{r}
oneway.test(length_stay_brutto ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
oneway.test(length_stay_brutto ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
oneway.test(length_stay_brutto ~ covid_pan, df_ed %>% filter(icd_f50_dd_ad))
```

### DD
```{r}
kruskal.test(icd_dd ~ covid_pan, df_ed)
kruskal.test(icd_dd ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
kruskal.test(icd_dd ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
```

### AD
```{r}
kruskal.test(icd_ad ~ covid_pan, df_ed)
kruskal.test(icd_ad ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
kruskal.test(icd_ad ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
```

### F50+DD+AD
```{r}
kruskal.test(icd_f50_dd_ad ~ covid_pan, df_ed)
```

### psychotropic discharge medication
```{r}
kruskal.test(psych_med ~ covid_pan, df_ed)
kruskal.test(psych_med ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
kruskal.test(psych_med ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
```


## Lockdowns
```{r}
df_ed_covid <- df_ed %>%
  filter(covid_lockd_sev != "pre_covid") %>%
  mutate(across(where(is.factor) & contains("covid"), fct_drop))
```

### Lockdown severity
```{r}
kruskal.test(icd_f50 ~ covid_lockd_sev, df_ed_covid)
# kruskal.test(f50_type ~ covid_lockd, df_ed_covid)
kruskal.test(f50_type == "Anorexie" ~ covid_lockd_sev, df_ed_covid)
kruskal.test(f50_type == "Bulimie" ~ covid_lockd_sev, df_ed_covid)
kruskal.test(f50_type == "Essstörung Sonst." ~ covid_lockd_sev, df_ed_covid)

kruskal.test(icd_f50_dd_ad ~ covid_lockd_sev, df_ed_covid)
```

kruskal.test(icd_f50_dd_ad ~ covid_lockd, df_ed_covid)
```


## GLM
! WIP, not finalised
```{r echo=TRUE}
# predicting ED
tmp <- glm(icd_f50 ~ covid_lockd + sex + age_adm + n_icd_f + n_icd_other + length_stay_brutto,
           family = binomial,
           data = df_ed)
summary(tmp)
# sex
# age_adm

# f50_type
# length_stay_netto/brutto
# n_icd_f/other/code
```
