---
title: "03_eating_disorder_descriptives"
author: "SP"
date: "`r Sys.Date()`"
output: 
  workflowr::wflow_html: 
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    number_sections: true
    df_print: paged
    fig_width: 11
    fig_height: 8
    fig_caption: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, echo = FALSE)
# knitr::opts_knit$set(root.dir = dirname(getwd()))
```

```{r libs, include=FALSE}
do_source_data_creation <- FALSE
source("code/eating_disorder_data_proc.R")
load_inst_pkgs("tidyverse", "psych", "DescTools", "janitor", "knitr")
do_save_objects <- FALSE
```

# Sample periods
- Pre-Covid from `r study_start` until `r covid_start`: `r pre_cov_dur` months (30-day periods)
- During Covid pandemic until `r study_end`: `r cov_dur` months (30 day periods)


# descriptives

## sample overview {.tabset .tabset-pills}
### age range
```{r}
df_ed %>%
  group_by(icd_f50) %>%
  summarise(min_age = min_na(age_adm),
            max_age = max_na(age_adm))
```
### number of cases per month (30 days) pre/during covid
```{r}
df_ed %>% 
  group_by(covid_pan) %>%
  summarise(n_cases = n_distinct(case_id),
            n_patients = n_distinct(p_id)) %>%
  mutate(months = c(pre_cov_dur, cov_dur)) %>%
  adorn_totals() %>%
  mutate(n_cases_month = n_cases/months,
         n_patients_month = n_patients/months)
```
### number of unique diagnoses per case
```{r}
df_diag %>%
  summarise(n = n_distinct(icd_code), .by = case_id) %>%
  ggplot(aes(x = n)) + geom_bar() + ggtitle("number of diagnoses per case")
```

## comparisons pre-pandemic vs during covid pandemic {.tabset .tabset-pills}
### means & SDs by ED & Covid
```{r}
summarise_mean_sd <- function(df) {
  summarise(df,
            across(c(age_adm, length_stay_brutto, n_icd_code, n_icd_f, n_icd_other, re_adm_lag),
                   list(mean = mean_na, sd = sd_na)), 
            n_cases = n())
}

df_ed_stats <- 
  # F50 all
  df_ed %>% summarise_mean_sd() %>% mutate(covid_pan = "total_dur", .before = 1) %>% 
  bind_rows(df_ed %>% group_by(covid_pan) %>% summarise_mean_sd()) %>% 
  mutate(icd_f50 = "all_diag", .before = 2) %>% 
  # F50 groups
  bind_rows(df_ed %>% group_by(icd_f50) %>% summarise_mean_sd() %>% mutate(covid_pan = "total_dur", .before = 1)) %>% 
  bind_rows(df_ed %>% group_by(icd_f50, covid_pan) %>% summarise_mean_sd()) %>% 
  mutate(covid_pan = fct(covid_pan, c("pre_covid", "dur_covid", "total_dur")),
         icd_f50 = fct(icd_f50, c("F50-", "F50+", "all_diag"))) %>% 
  arrange(icd_f50, covid_pan)
df_ed_stats
```
### ED counts & proportions by Covid
```{r}
df_ed %>% gen_tabyl(icd_f50, covid_pan)
df_ed %>% gen_tabyl(f50_type, covid_pan)
```
### psychotropic medication
```{r}
df_ed %>% filter(!is.na(psych_med)) %>% gen_tabyl(psych_med, covid_pan)
df_ed %>% filter(!is.na(psych_med)) %>% gen_tabyl(psych_med, icd_f50, covid_pan)
```

## sex & ED {.tabset .tabset-pills}
### sex counts & proportions by Covid
```{r}
df_ed %>% gen_tabyl(sex, covid_pan)
```
### ED counts & proportions by sex
```{r}
df_ed %>% gen_tabyl(icd_f50, sex)
df_ed %>% gen_tabyl(f50_type, sex)
```
### ED + sex counts & proportions by covid
```{r}
df_ed %>% gen_tabyl(icd_f50, sex, covid_pan)
df_ed %>% gen_tabyl(f50_type, sex, covid_pan)
```

## co-occuring depression & anxiety {.tabset .tabset-pills}
### DD
```{r}
df_ed %>% gen_tabyl(icd_dd, covid_pan)
df_ed %>% gen_tabyl(icd_dd, icd_f50, covid_pan)
```
### AD
```{r}
df_ed %>% gen_tabyl(icd_ad, covid_pan)
df_ed %>% gen_tabyl(icd_ad, icd_f50, covid_pan)
```
### F50+DD+AD
```{r}
df_ed %>% gen_tabyl(icd_f50_dd_ad, covid_pan)
df_ed %>% gen_tabyl(icd_f50_dd_ad, covid_lockd_sev)
df_ed %>% gen_tabyl(icd_f50_dd_ad, covid_period_i)
```
#### Length of stay
```{r}
df_ed %>%
  group_by(covid_pan, icd_f50_dd_ad) %>%
  summarise(los_mean = mean_na(length_stay_brutto), los_sd = sd_na(length_stay_brutto))
```

## Covid periods and school closures {.tabset .tabset-pills}
### ED counts & proportions for school closure severities
```{r}
df_ed %>% gen_tabyl(icd_f50, covid_lockd_sev)
df_ed %>% gen_tabyl(f50_type, covid_lockd_sev)
```
### ED and comorbidity counts & proportions for Covid pandemic phase
```{r}
df_ed %>% gen_tabyl(icd_f50, covid_period_i)
df_ed %>% gen_tabyl(f50_type, covid_period_i)
```

## re-admissions / first presentations {.tabset .tabset-pills}
### re-admissions within 6 months
```{r}
df_ed %>% gen_tabyl(re_adm_soon_nona, icd_f50, covid_pan)
```
### 2-year baseline comparison (2y baseline vs 2y covid, 2y lookback each)
#### baseline
```{r}
df_ed_re %>%
  filter(re_adm_period != "dur_covid") %>%
  group_by(p_id) %>%
  arrange(adm_date) %>%
  mutate(is_first_case = case_id == first(case_id, na_rm = TRUE),
         re_adm_lag = difftime(adm_date, coalesce(lag(dis_date), lag(adm_date)), units = "days"),
         re_adm_soon = re_adm_lag < re_adm_span) %>%
  ungroup() %>%
  filter(re_adm_period == "baseline") %>%
  gen_tabyl(is_first_case, icd_f50)
```
#### Covid pandemic
```{r}
df_ed_re %>%
  filter(re_adm_period != "pre") %>%
  group_by(p_id) %>%
  arrange(adm_date) %>%
  mutate(is_first_case = case_id == first(case_id, na_rm = TRUE),
         re_adm_lag = difftime(adm_date, coalesce(lag(dis_date), lag(adm_date)), units = "days"),
         re_adm_soon = re_adm_lag < re_adm_span) %>%
  ungroup() %>%
  filter(re_adm_period == "dur_covid") %>%
  gen_tabyl(is_first_case, icd_f50)
```


# Lists for Anorexia Nervosa (AN)

## AN non-psychiatric comorbidities
```{r}
df_diag %>% 
  select(case_id, icd_code, icd_label, icd_cat_l1, f50_type) %>% 
  filter("Anorexie" %in% f50_type, icd_cat_l1 == "somatische Diag.", .by = case_id) %>% 
  use_series(icd_code) %>%
  unique() %>% as.character() %>% sort() %T>% 
  {if (do_save_objects) write_lines(., file.path(outdir, "AN_somatische_KomorbiditÃ¤ten.txt"))}
```

## Medications in last week of stay
```{r}
data_exp$medication %>%
  select(case_id, med_start_date, med_end_date, med_nvl) %>% 
  inner_join(df_ed %>% filter(f50_type == "Anorexie") %>% select(case_id, dis_date)) %>% 
  # filter last week per case: med_end_date > dis_date-1week OR if NA med_start_date > dis_date-1week
  mutate(in_last_week = coalesce(med_end_date>(dis_date-weeks(1)), med_start_date>(dis_date-weeks(1)))) %>%
  filter(in_last_week) %>% 
  use_series(med_nvl) %>% 
  unique() %>% as.character() %>% sort() %T>%
  {if (do_save_objects) write_lines(., file.path(outdir, "AN_Medikation_letzte_Woche.txt"))}
```
