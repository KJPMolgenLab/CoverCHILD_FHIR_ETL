---
title: "03_eating_disorder_stats"
author: "SP"
date: "`r Sys.Date()`"
output: 
  workflowr::wflow_html: 
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    number_sections: true
    df_print: paged
    fig_width: 11
    fig_height: 8
    fig_caption: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, echo = FALSE)
# knitr::opts_knit$set(root.dir = dirname(getwd()))
```

```{r libs, include=FALSE}
do_source_data_creation <- FALSE
source("code/eating_disorder_data_proc.R")
load_inst_pkgs("tidyverse", "psych", "DescTools", "janitor", "knitr")
```

# Sample periods
- Pre-Covid from `r study_start` until `r covid_start`: `r pre_cov_dur` years
- During Covid pandemic until `r study_end`: `r cov_dur` years


# sample characteristics
## number of unique diagnoses per case
```{r}
df_diag %>%
  summarise(n = n_distinct(icd_code), .by = case_id) %>%
  ggplot(aes(x = n)) + geom_bar() + ggtitle("number of diagnoses per case")
```

## number of cases per year pre/during covid
```{r}
df_ed %>% 
  group_by(covid_pan) %>%
  summarise(n_cases = n_distinct(case_id),
            n_patients = n_distinct(p_id)) %>%
  mutate(years = c(pre_cov_dur, cov_dur)) %>%
  adorn_totals() %>%
  mutate(n_cases_year = n_cases/years,
         n_patients_year = n_patients/years)
```

## mean & sd by ED & Covid_pan
```{r}
summarise_mean_sd <- function(df) {
  summarise(df, 
            # across(where(~is.numeric(.x) | is.POSIXct(.x)), list(mean = ~mean(., na.rm = FALSE), sd = SD)), 
            across(c(age_adm, length_stay_brutto, n_icd_code, n_icd_f, n_icd_other, re_adm_lag),
                   list(mean = ~mean(., na.rm = TRUE), sd = ~DescTools::SD(., na.rm = TRUE))), 
            # across(sex, list(mean = ~mean(as.numeric(.)-1, na.rm = TRUE), sd = ~SD(as.numeric(.)-1))),
            # across(re_adm_soon, list(mean = ~mean(as.numeric(replace_na(., FALSE))),
            #                          sd = ~SD(as.numeric(replace_na(., FALSE))))),
            n_cases = n())
}

df_ed_stats <- 
  # F50 all
  df_ed %>% summarise_mean_sd() %>% mutate(covid_pan = "total_dur", .before = 1) %>% 
  bind_rows(df_ed %>% group_by(covid_pan) %>% summarise_mean_sd()) %>% 
  mutate(icd_f50 = "all_diag", .before = 2) %>% 
  # F50 groups
  bind_rows(df_ed %>% group_by(icd_f50) %>% summarise_mean_sd() %>% mutate(covid_pan = "total_dur", .before = 1)) %>% 
  bind_rows(df_ed %>% group_by(icd_f50, covid_pan) %>% summarise_mean_sd()) %>% 
  mutate(covid_pan = fct(covid_pan, c("pre_covid", "dur_covid", "total_dur")),
         icd_f50 = fct(icd_f50, c("F50-", "F50+", "all_diag"))) %>% 
  arrange(icd_f50, covid_pan)
df_ed_stats
```

## age range
```{r}
df_ed %>%
  group_by(icd_f50) %>%
  summarise(min_age = min_na(age_adm),
            max_age = max_na(age_adm))
```

## trend of ED diagnosis proportion
### full study period
```{r}
df_ed_share_month <- df_ed %>% 
  arrange(adm_date) %>% 
  mutate(adm_year = year(adm_date),
         adm_month = month(adm_date),
         adm_year_month = str_c(year(adm_date), ".", month(adm_date)) %>%
           fct_relevel(~str_sort(., numeric = TRUE)) %>%
           as.ordered(),
         adm_quarter = ordered(quarter(adm_date, type = "year.quarter"))
         ) %>%
  group_by(adm_year_month, adm_year, adm_month) %>% 
  summarise(#f50_prop = sum(icd_f50 == "F50+")/n()*100, 
            AN_prop = sum(f50_type == "Anorexie")/n()*100,
            BN_prop = sum(f50_type == "Bulimie")/n()*100,
            ED_sonst_prop = sum(f50_type == "Essstörung Sonst.")/n()*100,
            covid_lockd = Mode(covid_lockd),
            covid_lockd_i = Mode(covid_lockd_i)
            ) %>% 
  ungroup()

df_ed_share_month %>% 
  pivot_longer(ends_with("_prop"), names_to = "f50_prop_type", values_to = "f50_props") %>% 
  ggplot(aes(x = adm_year_month, y = f50_props, group = f50_prop_type)) + 
  geom_col(aes(fill = f50_prop_type)) +
  scale_fill_discrete(name = "ES Diagnose", labels = c("AN", "BN", "aES")) +
  # geom_line(aes(colour = f50_prop_type)) +
  guides(x = guide_axis(angle = -90)) + 
  geom_vline(aes(xintercept = "2020.3"), show.legend = FALSE) +
  # labs(title = "Proportion of cases with F50.* diagnoses per month", 
  #      x = "Year.Month", y = "cases with F50.* diagnosis [%]") +
  labs(title = "Prozentualer Anteil an Fällen mit Essstörungs-Diagnose pro Monat", 
       x = "Jahr.Monat", y = "Anteil der Fälle mit ES-Diagnose [%]") +
  geom_text(aes(x = "2020.3", y = 30, label = "Beginn\nCorona-\nPandemie", hjust = "left", vjust = "top"),
            nudge_x = 0.3, nudge_y = 0.5) +
  theme_classic()
```

### baseline-year comparison
```{r}
df_ed_share_month_yearly <- df_ed_share_month %>% 
  # summarise data for baseline year
  filter(covid_lockd == "pre_covid") %>%
  group_by(adm_month) %>%
  summarise(across(c(adm_year_month, adm_year, covid_lockd, covid_lockd_i), min_na),
            across(ends_with("_prop"), mean)) %>% 
  # add covid periods
  bind_rows(df_ed_share_month %>% filter(covid_lockd != "pre_covid"))

# year-cycle
df_ed_share_month_yearly %>%
  filter(covid_lockd != "pre_covid") %>%
  bind_rows(df_ed_share_month_yearly %>%
              filter(covid_lockd != "pre_covid") %>%
              select(c(adm_month, adm_year_month)) %>% 
              left_join(df_ed_share_month_yearly %>% 
                          filter(covid_lockd == "pre_covid") %>%
                          select(-adm_year_month)
                        )
            ) %>%
  mutate(covid_pan = if_else(adm_year == 2016, "baseline", "dur_covid")) %>% 
  ggplot(aes(x = adm_year_month, y = AN_prop, group = covid_pan)) +
  geom_line(aes(colour = covid_lockd)) +
  # scale_colour_discrete(name = "year") +
  # labs(title = "...",
  #      x = "month", y = "... [%]") +
  theme_classic()

# whole pandemic

```


### lockdown periods within covid pandemic
```{r}
df_ed_share_week <- df_ed %>% 
  arrange(adm_date) %>% 
  group_by(adm_week) %>% 
  summarise(#F50_prop = sum(icd_f50 == "F50+")/n()*100, 
            AN_prop = sum(f50_type == "Anorexie")/n()*100,
            BN_prop = sum(f50_type == "Bulimie")/n()*100,
            ED_sonst_prop = sum(f50_type == "Essstörung Sonst.")/n()*100) %>% 
  pivot_longer(ends_with("_prop"), names_to = "f50_prop_type", values_to = "f50_props") %>% 
  filter(adm_week >= "2020.10")

df_ed_share_week %>% 
  ggplot(aes(x = adm_week, y = f50_props, group = f50_prop_type)) + 
  geom_col() +
  geom_rect(data = df_lockdown_periods %>% filter(state == "Hessen", measure == "school"),
            mapping = aes(xmin = start_week, xmax = end_week, group = subperiod_i, alpha = ordered(status)),
            ymin = 0, ymax = 100, fill = scales::alpha("black", 0.2), inherit.aes = FALSE) +
  scale_alpha_ordinal(range = c(0.2, 0.5),
                      name = "Lockdown status", labels = c("1" = "partial", "2" = "full (incl. holidays)")) +
  geom_col(aes(fill = f50_prop_type)) +
  scale_fill_discrete(name = "ES Diagnose", labels = c("AN", "BN", "aES")) +
  scale_x_discrete(breaks = levels(df_ed_share_week$adm_week)[seq(1, length(levels(df_ed_share_week$adm_week)), 2)],
                   guide = guide_axis(angle = -90)) +
  # guides(x = guide_axis(angle = -90)) + 
  labs(title = "Anteil an Fällen mit Essstörungs-Diagnose während Covid-Pandemie pro Woche", 
       x = "Jahr.Woche", y = "Anteil der Fälle mit ES-Diagnose [%]") +
  # geom_text(aes(x = "2020.11", y = 95, label = "1. Schulschließung", hjust = "left", vjust = "top"),
  #           nudge_x = 1, nudge_y = 0.5) +
  # geom_text(aes(x = "2021.2", y = 95, label = "2. Schulschließung", hjust = "left", vjust = "top"),
  #           nudge_x = 1, nudge_y = 0.5) +
  theme_classic()
```

## periods of cases per patient
! WIP, not finalised
```{r}
# downsample F50- to match number of patients with ED. Proportion of F50- to F50+:
prop_f50min_to_plus <- 1.5

df_ed %>% 
  group_by(p_id) %>%
  mutate(n_cases = n()) %>%
  filter(n_cases > 1) %>%
  # filter(case_id != first(case_id)) %>% 
  ungroup() %>% 
  
  {filter(., icd_f50 == "F50+" | p_id %in% 
            sample(unique(.[.$icd_f50 == "F50-",]$p_id), 
                   round(length(unique(.[.$icd_f50 == "F50+",]$p_id))*prop_f50min_to_plus)))} %>%
  
  ggplot(aes(x = adm_date, xend = dis_date,
             y = fct_reorder(p_id, adm_date, first), yend = p_id,
             group = case_id, colour = f50_type)) +
  geom_segment() + 
  scale_x_datetime(date_breaks = "3 months", date_labels = "%y.%m", date_minor_breaks = "1 month", 
                   guide = guide_axis(angle = -90)) +
  # scale_y_discrete() +
  # scale_colour_viridis_d() + 
  geom_vline(aes(xintercept = as.POSIXct(covid_start)), show.legend = FALSE) + 
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) + 
  labs(title = "periods of treatments per patient", 
       x = "time", y = "patients", colour = "ED diag")
```

## ED counts & proportions by covid {.tabset .tabset-pills}
```{r}
df_ed %>% gen_tabyl(covid_pan, icd_f50)
df_ed %>% gen_tabyl(covid_pan, f50_type)
```

### sex counts & proportions by ED
```{r}
df_ed %>% gen_tabyl(covid_pan, sex)
df_ed %>% gen_tabyl(icd_f50, sex)
df_ed %>% gen_tabyl(f50_type, sex)
```

### ED + sex counts & proportions by covid
```{r}
df_ed %>% gen_tabyl(icd_f50, sex, covid_pan)
df_ed %>% gen_tabyl(f50_type, sex, covid_pan)
```

### sex counts & proportions for lockdowns
```{r}
#TODO include above
df_ed %>% gen_tabyl(covid_lockd, icd_f50)
df_ed %>% gen_tabyl(icd_f50, sex, covid_lockd)
```
### sex counts & proportions for lockdowns & ED subcategories
```{r}
df_ed %>% gen_tabyl(covid_lockd, f50_type)
df_ed %>% tabyl(covid_lockd, f50_type) %>% chisq.test()

df_ed %>% gen_tabyl(f50_type, sex, covid_lockd)

df_ed %>% gen_tabyl(covid_lockd_i, f50_type)
```

### co-occuring depression & anxiety
#### DD
```{r}
df_ed %>% gen_tabyl(covid_pan, icd_dd)
df_ed %>% gen_tabyl(covid_pan, icd_dd, icd_f50)
```
#### AD
```{r}
df_ed %>% gen_tabyl(covid_pan, icd_ad)
df_ed %>% gen_tabyl(covid_pan, icd_ad, icd_f50)
```
#### F50+DD+AD
```{r}
df_ed %>% gen_tabyl(covid_pan, icd_f50_dd_ad)
df_ed %>% gen_tabyl(covid_lockd, icd_f50_dd_ad)
```
#### LOS
```{r}
df_ed %>%
  group_by(covid_pan, icd_f50_dd_ad) %>%
  summarise(los_mean = mean(length_stay_brutto), los_sd = SD(length_stay_brutto)) # %>% View()
```

### psychotropic medication
```{r}
df_ed %>% filter(!is.na(psych_med)) %>% gen_tabyl(covid_pan, psych_med)
df_ed %>% filter(!is.na(psych_med)) %>% gen_tabyl(icd_f50, psych_med, covid_pan)
```


## re-admissions / first presentations

### within 6 months
```{r}
df_ed %>%
  mutate(re_adm_soon = replace_na(re_adm_soon, FALSE)) %>%
  gen_tabyl(icd_f50, re_adm_soon, covid_pan)
```

### 2-year baseline comparison
```{r}
df_ed_re <- df_ed %>%
  mutate(re_adm_period = if_else(covid_pan == "pre_covid",
                                 if_else(adm_date < ymd("2018-03-01"), "pre", "baseline"),
                                 covid_pan)) %>%
  filter(adm_date >= ymd("2016-03-01"))
```

#### v1: 2y baseline vs 2y covid, 2y lookback each
```{r}
df_ed_re %>%
  filter(re_adm_period != "dur_covid") %>%
  group_by(p_id) %>%
  arrange(adm_date) %>%
  mutate(is_first_case = case_id == first(case_id, na_rm = TRUE),
         re_adm_lag = difftime(adm_date, coalesce(lag(dis_date), lag(adm_date)), units = "days"),
         re_adm_soon = re_adm_lag < re_adm_span) %>%
  ungroup() %>%
  filter(re_adm_period == "baseline") %>%
  gen_tabyl(icd_f50, is_first_case)

df_ed_re %>%
  filter(re_adm_period != "pre") %>%
  group_by(p_id) %>%
  arrange(adm_date) %>%
  mutate(is_first_case = case_id == first(case_id, na_rm = TRUE),
         re_adm_lag = difftime(adm_date, coalesce(lag(dis_date), lag(adm_date)), units = "days"),
         re_adm_soon = re_adm_lag < re_adm_span) %>%
  ungroup() %>%
  filter(re_adm_period == "dur_covid") %>%
  gen_tabyl(icd_f50, is_first_case)
```

#### v2: 2y baseline vs 2y covid, no lookback #TODO
```{r}
# df_ed %>%
#   group_by(p_id, covid_pan) %>%
#   arrange(adm_date) %>%
#   mutate(is_first_case_by_covid = case_id == first(case_id, na_rm = TRUE),
#          re_adm_lag_by_covid = difftime(adm_date, coalesce(lag(dis_date), lag(adm_date)), units = "days"),
#          re_adm_soon_by_covid = re_adm_lag_by_covid < re_adm_span) %>%
#   ungroup()
```


# Lists for AN
## AN non-psychiatric comorbidities
```{r}
df_diag %>% 
  select(case_id, icd_code, icd_label, icd_cat_l1, f50_type) %>% 
  filter("Anorexie" %in% f50_type, icd_cat_l1 == "somatische Diag.", .by = case_id) %>% 
  use_series(icd_code) %>%
  unique() %>% as.character() %>% sort() %T>% 
  write_lines(file.path(outdir, "AN_somatische_Komorbiditäten.txt"))
```

## Medications in last week of stay
```{r}
data_exp$medication %>%
  select(case_id, med_start_date, med_end_date, med_nvl) %>% 
  inner_join(df_ed %>% filter(f50_type == "Anorexie") %>% select(case_id, dis_date)) %>% 
  # filter last week per case: med_end_date > dis_date-1week OR if NA med_start_date > dis_date-1week
  mutate(in_last_week = coalesce(med_end_date>(dis_date-weeks(1)), med_start_date>(dis_date-weeks(1)))) %>%
  filter(in_last_week) %>% 
  use_series(med_nvl) %>% 
  unique() %>% as.character() %>% sort() %T>%
  write_lines(file.path(outdir, "AN_Medikation_letzte_Woche.txt"))
```


# Modelling
```{r echo=TRUE}
n_tests <- 9
```

## Essstörungen während Pandemie {.tabset .tabset-pills}
### Fälle mit ED-Diagnose
```{r echo=TRUE}
mod_ed_pan <- kruskal.test(icd_f50 ~ covid_pan, df_ed)
# mod_ed_pan <- tabyl(df_ed, icd_f50, covid_pan) %>% chisq.test()
mod_ed_pan
```
Corrected p-value for multiple testing is: `r format(mod_ed_pan[["p.value"]]*n_tests, scientific = FALSE)`

### ED-Subgruppe Anorexie
```{r echo=TRUE}
mod_an_pan <- kruskal.test(f50_type == "Anorexie" ~ covid_pan, df_ed)
mod_an_pan
```
Corrected p-value for multiple testing is: `r format(mod_an_pan[["p.value"]]*n_tests, scientific = FALSE)`

### ED-Subgruppe Bulimie
```{r echo=TRUE}
mod_bu_pan <- kruskal.test(f50_type == "Bulimie" ~ covid_pan, df_ed)
mod_bu_pan
```
Corrected p-value for multiple testing is: `r format(mod_bu_pan[["p.value"]]*n_tests, scientific = FALSE)`

### ED-Subgruppe sonstige Esstörungen
```{r echo=TRUE}
mod_edsonst_pan <- kruskal.test(f50_type == "Essstörung Sonst." ~ covid_pan, df_ed)
mod_edsonst_pan
```
Corrected p-value for multiple testing is: `r format(mod_edsonst_pan[["p.value"]]*n_tests, scientific = FALSE)`


## klinische Präsentation während Pandemie {.tabset .tabset-pills}
### jüngeres Alter
```{r echo=TRUE}
# kruskal.test(age_adm ~ covid_pan, df_ed)
mod_age_pan <- oneway.test(age_adm ~ covid_pan, df_ed)
mod_age_pan
```
Corrected p-value for multiple testing is: `r format(mod_age_pan[["p.value"]]*n_tests, scientific = FALSE)`

### Geschlecht
```{r echo=TRUE}
# kruskal.test(age_adm ~ covid_pan, df_ed)
mod_sex_pan <- kruskal.test(sex ~ covid_pan, df_ed)
mod_sex_pan
```
Corrected p-value for multiple testing is: `r format(mod_sex_pan[["p.value"]]*n_tests, scientific = FALSE)`

### Zunahme Komorbiditäten - F
```{r echo=TRUE}
mod_como_f_pan <- oneway.test(n_icd_f ~ covid_pan, df_ed)
mod_como_f_pan
```
Corrected p-value for multiple testing is: `r format(mod_como_f_pan[["p.value"]]*n_tests, scientific = FALSE)`

### Zunahme Komorbiditäten - !F
```{r echo=TRUE}
mod_como_other_pan <- oneway.test(n_icd_other ~ covid_pan, df_ed)
mod_como_other_pan
```
Corrected p-value for multiple testing is: `r format(mod_como_other_pan[["p.value"]]*n_tests, scientific = FALSE)`

### Abnahme (!) Behandlungsdauer
```{r echo=TRUE}
mod_los_pan <- oneway.test(length_stay_brutto ~ covid_pan, df_ed)
mod_los_pan
```
Corrected p-value for multiple testing is: `r format(mod_los_pan[["p.value"]]*n_tests, scientific = FALSE)`

### re-admissions (v1)
```{r}
# non-ED
chisq.test(matrix(c(226, 225, 575, 576), nrow = 2))
# ED
chisq.test(matrix(c(39, 63, 54, 98), nrow = 2))
# combined
chisq.test(matrix(c(226+39, 225+63, 575+54, 576+98), nrow = 2))
```

### re-adm 6 months
```{r}
kruskal.test(re_adm_soon ~ covid_pan, df_ed %>% mutate(re_adm_soon = replace_na(re_adm_soon, FALSE)))
kruskal.test(re_adm_soon ~ covid_pan,
             df_ed %>% mutate(re_adm_soon = replace_na(re_adm_soon, FALSE)) %>% filter(icd_f50 == "F50+"))
kruskal.test(re_adm_soon ~ covid_pan,
             df_ed %>% mutate(re_adm_soon = replace_na(re_adm_soon, FALSE)) %>% filter(icd_f50 == "F50-"))
```

### age
```{r}
oneway.test(age_adm ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
oneway.test(age_adm ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
```

### sex
```{r}
kruskal.test(sex ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
kruskal.test(sex ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
```

### n diagnoses
```{r}
oneway.test(n_icd_code ~ covid_pan, df_ed)
oneway.test(n_icd_code ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
oneway.test(n_icd_code ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
```

### somatic comorbidities
```{r}
oneway.test(n_icd_other ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
oneway.test(n_icd_other ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
```

### psychiatric comorbidities
```{r}
oneway.test(n_icd_f ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
oneway.test(n_icd_f ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
```

### LOS
```{r}
oneway.test(length_stay_brutto ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
oneway.test(length_stay_brutto ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
oneway.test(length_stay_brutto ~ covid_pan, df_ed %>% filter(icd_f50_dd_ad))
```

### DD
```{r}
kruskal.test(icd_dd ~ covid_pan, df_ed)
kruskal.test(icd_dd ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
kruskal.test(icd_dd ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
```

### AD
```{r}
kruskal.test(icd_ad ~ covid_pan, df_ed)
kruskal.test(icd_ad ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
kruskal.test(icd_ad ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
```

### F50+DD+AD
```{r}
kruskal.test(icd_f50_dd_ad ~ covid_pan, df_ed)
```

### psychotropic discharge medication
```{r}
kruskal.test(psych_med ~ covid_pan, df_ed)
kruskal.test(psych_med ~ covid_pan, df_ed %>% filter(icd_f50 == "F50+"))
kruskal.test(psych_med ~ covid_pan, df_ed %>% filter(icd_f50 == "F50-"))
```


## Lockdowns
```{r}
df_ed_covid <- df_ed %>%
  filter(covid_lockd != "pre_covid") %>%
  mutate(across(where(is.factor) & contains("covid"), fct_drop))

kruskal.test(icd_f50 ~ covid_lockd, df_ed_covid)
# kruskal.test(f50_type ~ covid_lockd, df_ed_covid)
kruskal.test(f50_type == "Anorexie" ~ covid_lockd, df_ed_covid)
kruskal.test(f50_type == "Bulimie" ~ covid_lockd, df_ed_covid)
kruskal.test(f50_type == "Essstörung Sonst." ~ covid_lockd, df_ed_covid)

kruskal.test(icd_f50_dd_ad ~ covid_lockd, df_ed_covid)
```


## GLM
! WIP, not finalised
```{r echo=TRUE}
# predicting ED
tmp <- glm(icd_f50 ~ covid_lockd + sex + age_adm + n_icd_f + n_icd_other + length_stay_brutto,
           family = binomial,
           data = df_ed)
summary(tmp)
# sex
# age_adm

# f50_type
# length_stay_netto/brutto
# n_icd_f/other/code
```
